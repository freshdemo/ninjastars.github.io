---
layout: post
date:   2021-04-05 10:44:45 -0400
title:  "Web Server Compromise - Apache Struts"
categories: initialaccess
tags: waf
---
<p>
Remotely exploiting servers in DMZ's seems so unecessary today with all of the credential theft and client side exploitation, but it is still a critical link in the attack chain. Cloud initiatives are allowing administrators to start up servers all over the place, and most of the time they do not have the same protections in the cloud they typically would in the DMZ. This attack could also be applied for lateral movement if the vulnerable web application is only accessible internally.
</p>

<h3>Step 1 - Create a subdomain</h3>

<p>
In Dash create a subdomain called struts, point it to your origin, and ensure the traffic is being proxied (orange clouded).
<p>

<p>
It will look something like this;
<p>

<img src="/images/struts-dns.png">

<br><br>

<h3>Step 2 - Configure the WAF</h3>

<p>
Navigate to Firewall, Managed Rules, Cloudflare Specials.
</p>

<p>
Find <pre>ID 100054, Apache Struts - Command Injection - CVE:CVE-2017-5638</pre> and ensure the action is set to Block.
</p>

<img src="/images/struts-waf.png">

<br>
<br>

<h3>Step 3 - Deploy the Apache Struts</h3>

<p>
Typically this container would be added to your GCP infrastructure. The intrstructions to build your own vulnerable container can be found here, <a href="https://github.com/freshdemo/ApacheStruts-CVE-2018-11776">https://github.com/freshdemo/ApacheStruts-CVE-2018-11776</a>.
</p>


<h3>Step 4 - Run the Exploit</h3>

<p>
From a terminal outside of your origin network, run the exploit against the vulnerable server. 
</p>

<code>
   python ./exploit.py http://35.237.118.233:8080 'id'
</code>
<br>
<br>

<p>
Your output should look like this, providing nothing was in the way preventing the attack.
</p>
<pre>
root@k:/home/s# python ./exploit.py http://35.237.118.233:8080 'id'
[*] CVE: 2017-5638 - Apache Struts2 S2-045
http://35.237.118.233:8080 : [*] cmd: id

uid=0(root) gid=0(root) groups=0(root)
</pre>


<h3>Step 5 - View the Results</h3>


<p>
Navigate to Firewall, Overview, and scroll down to find Managed Rules. From there you can create a filter for rule ID 100054.
</p>

<img src="/images/struts-logs.png">



<!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "3ff248322f9d497f8802ebf7d47130c1"}'></script><!-- End Cloudflare Web Analytics -->
